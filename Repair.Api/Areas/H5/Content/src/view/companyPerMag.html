<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport" />
    <title>用户区域管理</title>
    <link rel="stylesheet" href="https://cdn.bootcss.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <link href="../css/my.css" rel="stylesheet" />
    <link href="//at.alicdn.com/t/font_newtymnvzenuerk9.css" rel="stylesheet" />
    <link href="../css/component.css" rel="stylesheet" />
    <link rel="stylesheet" href="../css/index.css">


    <style>

        .companyinfo {
            font-size: 11px;
            color: #bbb;
        }

        .list-group-item:active {
            color: #ccc;
        }
       .area-cursor{
           cursor:pointer;
       }
       .greenColor{
           background-color:green;
       }
      
    </style>
</head>
<body>
    <div id="CompanyPerList">
        <nav class="navbar navbar-fixed-top">
            <div class="person-info text-center">
                <a href="my.html" class="iconfont icon-fanhui btn-back"></a>
                设置人员所属区域
            </div>
        </nav>

        <div >
            <ul class="list-group" v-show="!noPerson">
                <li class="list-group-item" style="border:none;border-bottom:1px solid #ddd;" v-for="item in items" v-on:click="itemClick(item)" >
                    <div>昵称:{{item.NickName||'暂无'}}</div>
                    <div><span class="text-left companyinfo">手机号码:{{item.Phone||'暂无'}}</span><span class="text-right companyinfo">性别:{{item.Sex||'暂无'}}</span></div>
                    <div class="text-left companyinfo"> 邮箱:{{item.Email||'暂无'}}</div>
                    <div class="text-left companyinfo"> 所属区域:<span></span>{{item.AreaName||'暂无'}}</div>
                </li>
            </ul>
            <ul class="list-group" v-show="noPerson">
                <li class="list-group-item" style="border:none;border-bottom:1px solid #ddd;" >
                    <div class="text-center companyinfo">暂时还没有人员</div>
                </li>
            </ul>
        </div>
            <div class="area" id="area-show-panel" v-show="areaShow">
                <span class="search-tag area-cursor" v-bind:class="{ greenColor:!!area.isSelect }" data-type="area" data-id="{{area.id}}" v-for="area in areas" v-on:click="getSelectItem(area)">{{area.name}}</span>
            </div>
    </div>
    <script type="text/javascript" src="../js/jquery-3.1.0.js"></script>
    <script src="../common/httpParams.js"></script>
    <script type="text/javascript" src="../common/layer/layer.js"></script>
    <script type="text/javascript" src="../common/LayerFunction.js"></script>
    <script src="../common/vue.js"></script>
    <script type="text/javascript">
        var Mag = new Vue({
            el: "#CompanyPerList",
            data: {
                items: [],
                areaShow: false,
                areas: [],
                noPerson:false
            },
            methods: {
                getSelectItem: function (item) {                  
                    item.isSelect=!item.isSelect       
                },
                itemClick: function (obj) {
                    this.areaShow = true;
                    var self =this.areas.filter(function (item) {
                        item.isSelect = false;
                        return true;
                    });;
                    if (obj.AreaName) {
                        var arrArea = obj.AreaId.split(',');
                        if (arrArea.length > 0) {
                            for (var i = 0; i < arrArea.length - 1; i++) {                               
                                self[arrArea[i] - 1].isSelect = true;
                            }
                        }
                    } 
                    layer.open({
                        title:'区域列表',
                        type: 1,
                        closeBtn: false,
                        content: $('#area-show-panel'),
                        btn: ['提交', '取消'],
                        btnAlign: 'c', 
                        success: function (layero) {                           
                            var btn = layero.find('.layui-layer-btn');
                            btn.css('text-align', 'center');                            
                        },
                        yes: function (index, layero) {
                            var areaName='';                          
                            self.forEach(function (item) {
                                if (item.isSelect) {
                                    areaName += item.id + ','
                                }
                            });                           
                            if (areaName) {
                                $.post("/api/company/setcompanypersonarea", { userId: obj.UserId + '', areas: areaName }, function (res) {
                                    if (res.error) {
                                        layer.alert(res.error, { icon: 0 });
                                    } else {
                                        layer.msg('用户区域添加成功', {
                                            icon: 1,
                                            time: 1000
                                        }, function () {
                                            CloseLoad(index);
                                            location.reload();
                                        });
                                    }
                                });
                            } else {
                                layer.alert("请选择区域", { icon: 2 });
                            }
                        },
                        cancel: function (index) {                         
                           
                        }
                    });                   
                }                
            },
            created: function () {
                var self = this;               
                //加载区域
                $.get("/api/device/initdata", function (res) {
                    //初始化isSelect的值
                    self.areas = res.area.filter(function (item) {
                        item.isSelect = false;
                        return true;
                    });
                    $.get("/api/company/getcompanypersonlist", { appType: localStorage.appType }, function (res) {
                        if (res.length > 0) {
                            self.items = res.filter(function (item) {
                                if (item.AreaName) {
                                    var arrArea = item.AreaName.split(',');
                                    if (arrArea.length > 0) {
                                        //点击展开的时候用
                                        item.AreaId = item.AreaName;
                                        item.AreaName = '';
                                        for (var i = 0; i < arrArea.length - 1; i++) {
                                            item.AreaName += self.areas[arrArea[i] - 1].name + ',';
                                        }
                                    }
                                }
                                return true;
                            });
                        } else {
                            self.noPerson = true;
                        }
                      
                    });
                });

               
            }
        });

    </script>
</body>
</html>
